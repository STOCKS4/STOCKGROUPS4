<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Stock Barcode (S4 System)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
/* ====== CSS UI ‡∏õ‡∏Å‡∏ï‡∏¥ ====== */
body { font-family: 'Sarabun', sans-serif; background:#f1f5f9; padding:20px; color:#333; max-width: 900px; margin: 0 auto; }
.card { background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
input, select { width:100%; padding:14px; font-size:16px; margin-top:8px; border:1px solid #ccc; border-radius:8px; box-sizing: border-box; }
button { padding:12px; border:none; border-radius:8px; font-size:16px; cursor:pointer; margin-top:10px; }
.gen { background:#2563eb; color:#fff; }
.clear { background:#fee2e2; color:#dc2626; float:right; font-size:12px; padding:6px 12px; font-weight:bold; }

table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { padding:10px; border-bottom:1px solid #eee; }
.in { color:#16a34a; font-weight:bold; background:#dcfce7; padding:2px 8px; border-radius:4px; }
.out { color:#dc2626; font-weight:bold; background:#fee2e2; padding:2px 8px; border-radius:4px; }

/* Grid ‡∏õ‡∏Å‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö A4 */
.labels { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:20px; margin-top:20px; }
.label { border:2px dashed #cbd5e1; padding:10px; text-align:center; border-radius:10px; background:#fff; page-break-inside: avoid; width:100%; box-sizing:border-box; overflow:hidden; display:flex; flex-direction:column; justify-content:center; align-items:center; }

/* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Single (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å override ‡∏î‡πâ‡∏ß‡∏¢ JS) */
.labels.single-mode { display: block; }
.labels.single-mode .label { margin-bottom: 20px; border: 1px solid #ddd; page-break-after: always; margin-left: auto; margin-right: auto; }

.label-name { font-weight:bold; margin-bottom:2px; font-size:16px; color:#1e40af; line-height: 1.2; }
.barcode-wrap { width:100%; display:flex; justify-content:center; align-items:center; overflow:hidden; }
.label svg { max-width:100%; height:auto; display:block; }
.label-code { font-size:12px; font-family:monospace; margin-top:2px; font-weight:bold; word-break: break-all; }

#loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; text-align:center; padding-top:200px; font-size:24px; font-weight:bold; color:#2563eb; }

/* ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á */
#cameraArea { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; }
#cameraStream { width:100%; height:100%; object-fit:cover; }
.close-cam { position:absolute; top:20px; right:20px; background:red; color:white; padding:10px 20px; border-radius:30px; z-index:1001; font-weight:bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

.scan-line { position:absolute; top:40%; left:10%; width:80%; height:2px; background:red; animation:scanMove 2s infinite; }
@keyframes scanMove { 0%{top:30%}50%{top:50%}100%{top:30%} }

#scanFeedback { background:rgba(22,163,74,0.9); color:white; padding:15px; border-radius:10px; text-align:center; font-size:20px; font-weight:bold; opacity:0; transition:0.3s; margin-top:50px; }

/* ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Print */
.print-settings { background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #e2e8f0; }
.setting-row { display: flex; gap: 10px; align-items: flex-end; }
.setting-group { flex: 1; }
.setting-group label { font-size: 14px; color: #64748b; font-weight: bold; }

/* üî•üî•üî• CSS PRINT üî•üî•üî• */
@media print {
  body * { visibility: hidden; }
  #printArea, #printArea * { visibility: visible; }
  #printArea {
    position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0;
    background: white; box-shadow: none; border: none;
  }
  
  .labels { margin-top: 0; gap: 10px; }
  .label { border: none !important; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏ï‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á */

  /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î */
  @page { margin: 0.2cm; size: auto; }
}
</style>
</head>

<body>

<h2>üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô IN / OUT (S4 System)</h2>

<div class="card">
  <label><b>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -</b></label>
  <label style="margin-top:15px"><b>Barcode</b></label>
  <div style="display:flex; gap:10px">
    <input id="barcode" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î..." autofocus>
    <button onclick="startCamera()" style="background:#16a34a;color:white;">üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
  </div>
</div>

<div class="card">
  <h3>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <button class="clear" onclick="clearData()">‡∏•‡πâ‡∏≤‡∏á</button></h3>
  <table>
    <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>Barcode</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
    <tbody id="stock"></tbody>
  </table>
</div>

<hr>

<h2>üè∑Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á Barcode (Auto-Fit)</h2>
<div class="card">
  <input id="genName" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô 18802">
  <input id="genPrefix" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô 310169">
  <div style="display:flex; gap:10px">
      <input id="genQty" type="number" value="10" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
  </div>

  <div class="print-settings">
      <div class="setting-row">
          <div class="setting-group">
              <label>‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</label>
              <select id="printMode" onchange="togglePrintSettings()">
                  <option value="A4">A4 (‡∏´‡∏•‡∏≤‡∏¢‡∏î‡∏ß‡∏á)</option>
                  <option value="Single">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (‡∏î‡∏ß‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß)</option>
              </select>
          </div>
          <div class="setting-group" id="sizeSettings" style="display:none;">
              <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (mm)</label>
              <input id="pWidth" type="number" value="50">
          </div>
          <div class="setting-group" id="heightSettings" style="display:none;">
              <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (mm)</label>
              <input id="pHeight" type="number" value="30">
          </div>
      </div>
  </div>

  <button class="gen" onclick="requestBarcodes()">‚òÅÔ∏è ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å Server</button>
  <button class="gen" style="background:#475569" onclick="window.print()">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>
</div>

<div class="card" id="printArea">
  <div class="labels" id="labels"></div>
</div>

<div id="cameraArea">
    <button class="close-cam" onclick="stopCamera()">‚ùå ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
    <div id="cameraStream"></div>
</div>
<div style="position:fixed;bottom:50px;left:0;width:100%;display:flex;justify-content:center;z-index:1002;pointer-events:none;">
    <div id="scanFeedback"></div>
</div>

<script>
// ‚úÖ URL Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ)
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxlC36QoUV37QvM6fazvGOlf5daaHrmdVTjQuHqpRnX_kTOFt7q3JbjwZ7H-rHBM00/exec';

let logs = JSON.parse(localStorage.getItem('logs_team') || '[]');
let itemStatus = JSON.parse(localStorage.getItem('item_status') || '{}');

const barcodeInput = document.getElementById('barcode');
const stockEl = document.getElementById('stock');
const feedbackEl = document.getElementById('scanFeedback');

// UI Toggle Logic
function togglePrintSettings() {
    const mode = document.getElementById('printMode').value;
    const sizeSet = document.getElementById('sizeSettings');
    const heightSet = document.getElementById('heightSettings');
    
    if (mode === 'Single') {
        sizeSet.style.display = 'block';
        heightSet.style.display = 'block';
    } else {
        sizeSet.style.display = 'none';
        heightSet.style.display = 'none';
    }
}

// ===== MAIN FLOW =====
barcodeInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
     e.preventDefault(); 
     processBarcode();   
  }
});

async function processBarcode(code=null){
  let raw = code || barcodeInput.value.replace('!','').trim();
  if(!raw) return;

  let productCode = raw.split('-')[0];
  productCode = productCode.split('_')[0];

  try {
      const res = await fetch(SHEET_URL,{
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body:JSON.stringify({
            actionType:'GET_PRODUCT', 
            code:productCode,
            fullBarcode: raw 
        })
      });

      const data = await res.json();

      if(data.status !== 'success'){
        alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô PRODUCT_LIST : ' + productCode);
        barcodeInput.value='';
        return;
      }

      const fullName = data.full_name;
      let lastServerAction = data.last_action || 'OUT'; 
      let action = (lastServerAction === 'IN') ? 'OUT' : 'IN'; 

      fetch(SHEET_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
              actionType: 'LOG', 
              barcode: raw,
              name: fullName,
              action: action,
              fixedCode: data.code 
          })
      });

      const record = { barcode:raw, name:fullName, action:action, time:Date.now() };
      logs.push(record);
      itemStatus[raw] = action; 
      
      saveAndRender();
      barcodeInput.value='';
      showScanFeedback(`${fullName} (${action})`);

  } catch (err) {
      console.error(err);
      alert("‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
  }
}

function saveAndRender(){
  localStorage.setItem('logs_team',JSON.stringify(logs));
  localStorage.setItem('item_status',JSON.stringify(itemStatus));

  stockEl.innerHTML='';
  [...logs].reverse().slice(0,15).forEach(r=>{
    const d=new Date(r.time);
    stockEl.innerHTML+=`<tr>
      <td>${d.toLocaleTimeString()}</td>
      <td style="font-family:monospace;font-weight:bold">${r.barcode}</td>
      <td>${r.name}</td>
      <td><span class="${r.action==='IN'?'in':'out'}">${r.action}</span></td>
    </tr>`;
  });
}

function clearData(){
  if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){
    logs=[]; itemStatus={};
    saveAndRender();
  }
}

/* ===== Barcode Generator ===== */
async function requestBarcodes(){
  const name=document.getElementById('genName').value.trim();
  const prefix=document.getElementById('genPrefix').value.trim();
  const qty=parseInt(document.getElementById('genQty').value);
  if(!name||!prefix||qty<=0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

  const res=await fetch(SHEET_URL,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({actionType:'GENERATE',name,prefix,qty})
  });
  const data=await res.json();
  if(data.status==='success'){
    renderBarcodes(name,prefix,data.start,data.end);
  }
}

// ‚úÖ Render Function ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß
function renderBarcodes(name,prefix,start,end){
  const labels = document.getElementById('labels');
  labels.innerHTML='';
  let i=0;
  
  // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Config
  const mode = document.getElementById('printMode').value;
  const widthVal = document.getElementById('pWidth').value || 50;
  const heightVal = document.getElementById('pHeight').value || 30;

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CSS Container ‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
  if(mode === 'Single'){
      labels.classList.add('single-mode');
  } else {
      labels.classList.remove('single-mode');
  }

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Max Width (px) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Auto-Fit
  let maxW = 200; // Default A4
  if(mode === 'Single'){
     // 1mm = 3.78px, ‡πÉ‡∏ä‡πâ 90% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏ö
     maxW = widthVal * 3.78 * 0.90;
  }

  for(let n=start;n<=end;n++){
    const num=String(n).padStart(3,'0');
    const code=`${name}-${prefix}${num}!`;
    const div=document.createElement('div');
    div.className='label';
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î Single ‡πÉ‡∏´‡πâ Fix ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á
    if(mode === 'Single'){
        div.style.width = widthVal + 'mm';
        div.style.height = heightVal + 'mm';
    }

    div.innerHTML=`
      <div class="label-name">${name}</div>
      <div class="barcode-wrap">
         <svg id="bc${i}"></svg>
      </div>
      <div class="label-code">${code}</div>
    `;
    labels.appendChild(div);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Barcode
    JsBarcode(`#bc${i}`, code, { 
        format: 'CODE128', 
        width: 2,      
        height: (mode==='Single' ? (heightVal*1.5) : 40), // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
        margin: 0,
        displayValue: false 
    });

    // Auto-Fit Logic
    const svg = document.getElementById(`bc${i}`);
    const currentW = svg.getBoundingClientRect().width;
    
    if(mode === 'Single' && currentW > maxW){
        const scale = maxW / currentW;
        svg.style.transform = `scaleX(${scale})`;
        svg.style.transformOrigin = 'center';
        svg.style.width = '100%'; 
    } else if (mode === 'A4') {
        svg.style.maxWidth = '100%';
        svg.style.height = 'auto';
    }

    i++;
  }
}

/* ===== CAMERA ===== */
let lastCode="", lastTime=0;
function startCamera(){
  const cameraArea = document.getElementById('cameraArea');
  const cameraStream = document.getElementById('cameraStream');
  cameraArea.style.display='block';

  Quagga.init({
    inputStream:{
        name:"Live",
        type:"LiveStream",
        target:cameraStream,
        constraints:{facingMode:"environment"}
    },
    decoder:{readers:["code_128_reader"]},
    locate:true
  }, function(err) {
      if (err) { console.log(err); return }
      Quagga.start();
  });

  Quagga.onDetected(r=>{
    const code=r.codeResult.code;
    const now=Date.now();
    if(code===lastCode && now-lastTime<2000) return;
    lastCode=code; lastTime=now;
    processBarcode(code.replace('!',''));
  });
}

function stopCamera(){ 
    Quagga.stop(); 
    document.getElementById('cameraArea').style.display='none'; 
}

function showScanFeedback(text){
  feedbackEl.innerText=text;
  feedbackEl.style.opacity=1;
  setTimeout(()=>feedbackEl.style.opacity=0,1500);
}

saveAndRender();
</script>

</body>
</html>
