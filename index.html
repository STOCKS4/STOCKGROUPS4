<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>S4 Stock System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Sarabun:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

<style>
/* ====== 1. SYSTEM DESIGN ====== */
:root {
    --primary: #0f172a; --accent: #3b82f6; --bg-body: #f1f5f9; --text-main: #334155;
}
body { font-family: 'Inter', 'Sarabun', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; }

/* Header & Layout */
header { background: var(--primary); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.brand { font-weight: 700; font-size: 1.2rem; }
.container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: grid; grid-template-columns: 1fr 350px; gap: 24px; }
@media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

/* Cards & UI */
.card { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; overflow: hidden; }
.card-header { padding: 1rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-weight: 600; display: flex; justify-content: space-between; }
.card-body { padding: 1.5rem; }

/* Inputs & Buttons */
input, select { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
.btn { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; }
.btn-primary { background: var(--accent); } .btn-dark { background: var(--primary); }
.btn-icon { width: auto; padding: 0 20px; background: #10b981; }

/* Table */
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
th, td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: left; }
th { background: #f8fafc; color: #64748b; }

/* ====== 2. PRINT PREVIEW (‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠) ====== */
.settings-grid { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed #cbd5e1; margin-bottom: 15px; }
.labels-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 10px; }
.label-item { 
    background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; text-align: center; 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.label-item svg { max-width: 100%; height: auto; display: block; shape-rendering: crispEdges; }

/* Overlays */
#scanFeedback { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000; }
#cameraArea { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; }
#cameraStream { width: 100%; height: 100%; object-fit: cover; }

/* ====== 3. PRINT ENGINE (‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‡∏´‡∏≤‡∏¢‡∏Ç‡∏≤‡∏î) ====== */
@media print {
    /* ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á */
    body { background: white; margin: 0; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    header, .container, #scanFeedback, #cameraArea { display: none !important; }
    
    #printArea { display: block !important; position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 0; }

    /* üî• MODE A4: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Grid ‡πÅ‡∏ô‡πà‡∏ô‡πÜ üî• */
    .mode-a4 .labels-container {
        display: grid !important;
        grid-template-columns: repeat(4, 1fr) !important; /* 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
        gap: 10px 10px !important; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á */
        padding: 10px !important;
    }
    .mode-a4 .label-item {
        border: 1px dashed #ccc !important;
        box-shadow: none !important;
        break-inside: avoid !important;      /* ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡∏î‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏î‡∏ß‡∏á */
        page-break-inside: avoid !important;
        margin: 0 !important;
        height: auto !important;
    }

    /* üî• MODE THERMAL: ‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏î‡∏ß‡∏á üî• */
    .mode-single .labels-container { display: block !important; }
    .mode-single .label-item {
        border: none !important;
        page-break-after: always !important; /* ‡∏à‡∏ö‡∏î‡∏ß‡∏á ‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà */
        break-after: page !important;
        margin: 0 auto !important;
        width: 100% !important;
        height: 100% !important;
        display: flex; justify-content: center; align-items: center;
    }
}
</style>
</head>
<body>

<header>
    <div class="brand">üì¶ S4 StockBarcode</div>
    <div style="font-size:0.9rem; opacity:0.8;">System Online</div>
</header>

<div class="container">
    <div>
        <div class="card">
            <div class="card-header">Scan Product</div>
            <div class="card-body" style="display:flex; gap:10px;">
                <input id="barcode" placeholder="Click & Scan..." autofocus>
                <button class="btn btn-icon" onclick="startCamera()">üì∑</button>
            </div>
        </div>
        <div class="card">
            <div class="card-header">History <button onclick="clearData()" style="background:none; border:none; color:red; cursor:pointer;">Clear</button></div>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Time</th><th>Info</th><th>Status</th></tr></thead>
                    <tbody id="stock"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div>
        <div class="card" style="position:sticky; top:20px;">
            <div class="card-header">Barcode Generator</div>
            <div class="card-body">
                <div class="settings-grid">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</label>
                    <select id="printMode" onchange="updatePrintConfig()">
                        <option value="A4">A4 Paper (Grid)</option>
                        <option value="Single">Thermal Roll (1/Page)</option>
                    </select>
                    
                    <div id="sizeInputs" style="display:none; gap:5px; margin-top:10px;">
                        <input id="pWidth" type="number" value="50" placeholder="W"><span style="align-self:center">x</span>
                        <input id="pHeight" type="number" value="30" placeholder="H"><span style="align-self:center">mm</span>
                    </div>
                </div>

                <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="genName" placeholder="Product_LIST Only">
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input id="genQty" type="number" value="10">

                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="requestBarcodes()">‡∏™‡∏£‡πâ‡∏≤‡∏á Code</button>
                    <button class="btn btn-dark" onclick="window.print()">Print</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="printArea">
    <div id="labelsContainer" class="labels-container"></div>
</div>

<div id="cameraArea"><button onclick="stopCamera()" style="position:absolute; top:20px; right:20px; background:white; padding:10px 20px; border:none; border-radius:30px;">Close</button><div id="cameraStream"></div></div>
<div id="scanFeedback"></div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxlC36QoUV37QvM6fazvGOlf5daaHrmdVTjQuHqpRnX_kTOFt7q3JbjwZ7H-rHBM00/exec';
let logs = JSON.parse(localStorage.getItem('logs_s4') || '[]');
const els = { barcode: document.getElementById('barcode'), stock: document.getElementById('stock'), container: document.getElementById('labelsContainer'), printArea: document.getElementById('printArea'), feedback: document.getElementById('scanFeedback') };

// Load Settings
if(localStorage.getItem('print_w')) document.getElementById('pWidth').value = localStorage.getItem('print_w');
if(localStorage.getItem('print_h')) document.getElementById('pHeight').value = localStorage.getItem('print_h');
if(localStorage.getItem('print_mode')) document.getElementById('printMode').value = localStorage.getItem('print_mode');

function updatePrintConfig(){
    const mode = document.getElementById('printMode').value;
    const w = document.getElementById('pWidth').value || 50;
    const h = document.getElementById('pHeight').value || 30;
    
    // 1. UI Toggle
    document.getElementById('sizeInputs').style.display = (mode === 'Single') ? 'flex' : 'none';
    
    // 2. Class Toggle (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏•‡∏±‡∏ö Class ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô CSS Print)
    els.printArea.className = (mode === 'Single') ? 'mode-single' : 'mode-a4';
    
    // 3. Page Rule Injection
    const styleId = 'dynamic-page-size';
    let styleTag = document.getElementById(styleId);
    if(styleTag) styleTag.remove();
    
    styleTag = document.createElement('style');
    styleTag.id = styleId;
    if(mode === 'Single'){
        styleTag.innerHTML = `@media print { @page { size: ${w}mm ${h}mm; margin: 0; } }`;
    } else {
        styleTag.innerHTML = `@media print { @page { size: A4; margin: 0.5cm; } }`;
    }
    document.head.appendChild(styleTag);

    localStorage.setItem('print_mode', mode); localStorage.setItem('print_w', w); localStorage.setItem('print_h', h);
}
document.getElementById('pWidth').addEventListener('input', updatePrintConfig);
document.getElementById('pHeight').addEventListener('input', updatePrintConfig);
updatePrintConfig();

// Scan Logic
els.barcode.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); processScan(); } });
async function processScan(code=null){
    let raw = code || els.barcode.value.replace(/\s/g,'').trim();
    if(!raw) return;
    let productKey = raw;
    if(raw.includes('!') || (raw.includes('-') && raw.length > 5) || (raw.length > 8 && !isNaN(raw))) {
         let clean = raw.replace(/!/g,'').replace(/-/g, '');
         if(clean.length > 5) productKey = clean.substring(0, clean.length - 3);
    }
    showFeedback('Processing...', '#334155');
    try {
        const res = await fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'GET_PRODUCT', code: productKey, fullBarcode: raw }) });
        const data = await res.json();
        if(data.status !== 'success'){ showFeedback('Not Found', '#ef4444'); els.barcode.value = ''; return; }
        let action = (data.last_action === 'IN') ? 'OUT' : 'IN';
        fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'LOG', barcode: raw, name: data.full_name, action: action, fixedCode: data.code }) });
        logs.unshift({ time: Date.now(), barcode: raw, name: data.full_name, action: action });
        if(logs.length > 50) logs.pop();
        localStorage.setItem('logs_s4', JSON.stringify(logs));
        renderLogs();
        els.barcode.value = '';
        showFeedback(`${action}: ${data.full_name}`, action==='IN'?'#10b981':'#ef4444');
    } catch (err) { showFeedback('Error', '#ef4444'); }
}

function renderLogs(){
    if(logs.length === 0) { els.stock.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#94a3b8;">No history</td></tr>'; return; }
    els.stock.innerHTML = logs.map(l => `
        <tr>
            <td style="color:#64748b; font-size:0.85rem;">${new Date(l.time).toLocaleTimeString('th-TH')}</td>
            <td><div style="font-weight:600;">${l.name}</div><div style="font-family:monospace;">${l.barcode}</div></td>
            <td><span style="padding:2px 8px; border-radius:4px; font-weight:bold; font-size:0.8em; background:${l.action==='IN'?'#dcfce7':'#fee2e2'}; color:${l.action==='IN'?'#166534':'#991b1b'};">${l.action}</span></td>
        </tr>`).join('');
}
function clearData(){ if(confirm('Clear history?')){ logs=[]; localStorage.removeItem('logs_s4'); renderLogs(); } }
function showFeedback(text, color){ els.feedback.innerText = text; els.feedback.style.background = color; els.feedback.style.opacity = 1; setTimeout(() => els.feedback.style.opacity = 0, 1500); }

// Generate Logic
async function requestBarcodes(){
    const name = document.getElementById('genName').value.trim();
    const qty = parseInt(document.getElementById('genQty').value);
    if(!name || qty <= 0) return alert('Enter details');
    showFeedback('Generating...', '#334155');
    const res = await fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'GENERATE', name: name, qty: qty }) });
    const data = await res.json();
    if(data.status === 'success'){ generateLabels(name, data.start, data.end); showFeedback('Ready to Print', '#10b981'); }
}

function generateLabels(name, start, end){
    els.container.innerHTML = '';
    const mode = document.getElementById('printMode').value;
    const w = document.getElementById('pWidth').value || 50;
    const h = document.getElementById('pHeight').value || 30;
    
    updatePrintConfig(); // Refresh print settings

    for(let i = start; i <= end; i++){
        const num = String(i).padStart(3, '0');
        const humanText = `${name}-${num}`;
        const machineCode = `${name}${num}!`;
        const div = document.createElement('div');
        div.className = 'label-item';
        
        // Show actual size preview if thermal
        if(mode === 'Single'){ div.style.width = w + 'mm'; div.style.height = h + 'mm'; }

        div.innerHTML = `<div style="font-weight:bold;margin-bottom:2px;">${name}</div><svg id="bc_${i}"></svg><div style="font-family:monospace;font-size:12px;">${humanText}</div>`;
        els.container.appendChild(div);
        
        JsBarcode(`#bc_${i}`, machineCode, { format: "CODE128", width: 2, height: (mode === 'Single' ? 30 : 40), displayValue: false, margin: 0 });
    }
}

// Camera
let lastCam=0;
function startCamera(){ document.getElementById('cameraArea').style.display='block'; Quagga.init({ inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#cameraStream'), constraints: { facingMode: "environment" } }, decoder: { readers: ["code_128_reader", "ean_reader", "upc_reader"] }, locate: true }, (err) => { if(!err) Quagga.start(); }); Quagga.onDetected((d) => { if(Date.now()-lastCam<2000)return; lastCam=Date.now(); processScan(d.codeResult.code.replace(/!/g,'')); }); }
function stopCamera(){ Quagga.stop(); document.getElementById('cameraArea').style.display='none'; }

renderLogs();
</script>
</body>
</html>
