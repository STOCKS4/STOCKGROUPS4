<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>S4 Inventory (Print Perfect)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Sarabun:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

<style>
/* ====== THEME ====== */
:root { --primary: #0f172a; --accent: #2563eb; --bg-body: #f1f5f9; --text-main: #334155; --border: #cbd5e1; }
body { font-family: 'Inter', 'Sarabun', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; line-height: 1.5; }

/* Header */
header { background: var(--primary); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
.brand { font-weight: 700; font-size: 1.25rem; }

/* Layout */
.container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: grid; grid-template-columns: 1fr 350px; gap: 24px; }
@media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

/* UI Components */
.card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
.card-header { padding: 1rem 1.5rem; background: #fff; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--primary); }
.card-body { padding: 1.5rem; }

input, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; font-family: 'Sarabun', sans-serif; }
label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.85rem; color: #64748b; }

.btn { width: 100%; padding: 0.75rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; font-size: 0.95rem; margin-top: 5px; }
.btn-primary { background: var(--accent); } 
.btn-dark { background: var(--primary); }
.btn-outline { background: transparent; border: 1px solid var(--border); color: #64748b; width: auto; padding: 0.4rem 1rem; }
.btn-scan { background: #10b981; width: auto; padding: 0 1.5rem; }

/* Table */
.table-responsive { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
th { background: #f8fafc; color: #64748b; font-weight: 600; }
.badge { padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
.badge-in { background: #dcfce7; color: #166534; } .badge-out { background: #fee2e2; color: #991b1b; }

/* QR Preview (‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠) */
.preview-area { background: #e2e8f0; padding: 20px; border-radius: 8px; min-height: 200px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
.label-preview { 
    background: white; 
    border: 1px dashed red; /* ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡∏≠‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    overflow: hidden;
    position: relative;
}
.qr-box img { display: block; margin: 0 auto; }
.lbl-name { font-weight: 700; color: #000; font-size: 14px; line-height: 1.2; width: 95%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
.lbl-code { font-family: 'Roboto Mono', monospace; font-size: 12px; color: #000; font-weight: 600; margin-top: 2px; }

/* Camera */
#reader { width: 100%; border-radius: 8px; overflow: hidden; margin-top: 10px; display: none; border: 2px solid var(--accent); }
#scanFeedback { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; z-index: 2000; font-weight: 600; text-align: center; opacity: 0; pointer-events: none; transition: 0.3s; }

/* üî• PRINT ENGINE (CENTERING FIX) üî• */
@media print {
    body { background: white; margin: 0; padding: 0; }
    header, .container, #scanFeedback, #reader { display: none !important; }
    
    #printArea { 
        display: block !important; 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 0; 
    }

    /* Thermal Mode: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
    .mode-single { width: 100%; height: 100%; }
    .label-preview {
        border: none !important; /* ‡πÄ‡∏≠‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏î‡∏á‡∏≠‡∏≠‡∏Å‡∏ï‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á */
        box-shadow: none !important;
        margin: 0 auto !important;
        page-break-after: always !important; /* ‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤ */
        break-after: page !important;
        
        /* üî• ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
        
        /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ */
        width: 100% !important;
        height: 100% !important;
    }
    
    /* A4 Grid Mode */
    .mode-a4 { 
        display: grid; 
        grid-template-columns: repeat(5, 1fr); 
        gap: 10px; padding: 10px; 
    }
    .mode-a4 .label-preview { border: 1px dashed #ccc !important; page-break-after: auto !important; }
}
</style>
</head>
<body>

<header>
    <div class="brand">üì¶ S4 Inventory</div>
    <div style="font-size:0.85rem; background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:20px;">üü¢ Online</div>
</header>

<div class="container">
    
    <div>
        <div class="card">
            <div class="card-header">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            <div class="card-body">
                <div style="display:flex; gap:10px;">
                    <div style="flex-grow:1;"><input id="barcode" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏¥‡∏á..." autofocus autocomplete="off"></div>
                    <button class="btn btn-scan" id="btnCamToggle" onclick="toggleCamera()">‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                </div>
                <div id="debugLine" style="font-size:0.8rem; color:#64748b; margin-top:5px; min-height:1.5em;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                <div id="reader"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ <button class="btn-outline" style="float:right" onclick="clearData()">‡∏•‡πâ‡∏≤‡∏á</button></div>
            <div class="table-responsive">
                <table><thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody id="stock"></tbody></table>
            </div>
        </div>
    </div>

    <div>
        <div class="card" style="position:sticky; top:20px;">
            <div class="card-header">üñ®Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© & ‡∏™‡∏£‡πâ‡∏≤‡∏á QR</div>
            <div class="card-body">
                
                <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</label>
                <select id="printMode" onchange="updatePrintConfig()">
                    <option value="Single">üßª Thermal (‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏°‡πâ‡∏ß‡∏ô)</option>
                    <option value="A4">üìÑ A4 (‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</option>
                </select>

                <div id="sizeInputs" style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:15px;">
                    <label>üìè ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (‡∏°‡∏°.)</label>
                    <div style="display: flex; gap: 10px;">
                        <div><input id="pWidth" type="number" value="50"><div style="font-size:0.7rem; color:#64748b; text-align:center;">‡∏Å‡∏ß‡πâ‡∏≤‡∏á</div></div>
                        <div style="padding-top:10px;">x</div>
                        <div><input id="pHeight" type="number" value="30"><div style="font-size:0.7rem; color:#64748b; text-align:center;">‡∏™‡∏π‡∏á</div></div>
                    </div>
                    <div style="font-size:0.75rem; color:red; margin-top:5px;">*‡∏ß‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà!</div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:2"><label>‡∏£‡∏´‡∏±‡∏™</label><input id="genName" placeholder="‡πÄ‡∏ä‡πà‡∏ô s-an6-4mm"></div>
                    <div style="flex:1"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input id="genQty" type="number" value="1"></div>
                </div>

                <button class="btn btn-primary" onclick="requestBarcodes()">‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</button>
                <button class="btn btn-dark" onclick="window.print()">‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>

            </div>
        </div>
    </div>

</div>

<div id="printArea" class="preview-area">
    <div style="color:#64748b;">(‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• QR Code ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)</div>
</div>

<div id="scanFeedback"></div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxlC36QoUV37QvM6fazvGOlf5daaHrmdVTjQuHqpRnX_kTOFt7q3JbjwZ7H-rHBM00/exec';
const SEPARATOR = "___"; 
let logs = JSON.parse(localStorage.getItem('logs_s4') || '[]');
const els = { barcode: document.getElementById('barcode'), stock: document.getElementById('stock'), printArea: document.getElementById('printArea'), feedback: document.getElementById('scanFeedback'), debug: document.getElementById('debugLine') };

// Init Settings
if(localStorage.getItem('print_w')) document.getElementById('pWidth').value = localStorage.getItem('print_w');
if(localStorage.getItem('print_h')) document.getElementById('pHeight').value = localStorage.getItem('print_h');

// ================= PRINT CONFIG (DYNAMIC SIZE) =================
function updatePrintConfig(){
    const mode = document.getElementById('printMode').value;
    const w = document.getElementById('pWidth').value || 50;
    const h = document.getElementById('pHeight').value || 30;
    
    // UI Logic
    document.getElementById('sizeInputs').style.display = (mode === 'Single') ? 'block' : 'none';
    els.printArea.className = (mode === 'Single') ? 'mode-single' : 'mode-a4'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô class ‡πÅ‡∏°‡πà
    
    // Inject @Page CSS
    let styleTag = document.getElementById('dynamic-page-size');
    if(styleTag) styleTag.remove();
    styleTag = document.createElement('style'); styleTag.id = 'dynamic-page-size';
    
    if(mode === 'Single'){
        // Thermal: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡πä‡∏∞‡πÜ + ‡∏•‡πâ‡∏≤‡∏á Margin
        styleTag.innerHTML = `
            @media print { 
                @page { size: ${w}mm ${h}mm; margin: 0; } 
                html, body { width: ${w}mm; height: ${h}mm; }
            }
            /* Preview ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
            .label-preview { width: ${w}mm; height: ${h}mm; } 
        `;
    } else {
        styleTag.innerHTML = `@media print { @page { size: A4; margin: 0.5cm; } } .label-preview { width: 50mm; height: 50mm; }`;
    }
    document.head.appendChild(styleTag);
    
    localStorage.setItem('print_mode', mode); localStorage.setItem('print_w', w); localStorage.setItem('print_h', h);
}
document.getElementById('pWidth').addEventListener('input', updatePrintConfig);
document.getElementById('pHeight').addEventListener('input', updatePrintConfig);
document.getElementById('printMode').addEventListener('change', updatePrintConfig);
updatePrintConfig();

// ================= GENERATOR LOGIC =================
async function requestBarcodes(){
    const name = document.getElementById('genName').value.trim();
    const qty = parseInt(document.getElementById('genQty').value);
    if(!name || qty <= 0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
    
    showFeedback('‚è≥ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR...', '#334155');
    
    // Clear old
    els.printArea.innerHTML = '';

    // Generate Local (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Server ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR)
    // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Server (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß)
    const res = await fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'GENERATE', name: name, qty: qty }) });
    const data = await res.json();

    if(data.status === 'success'){
        generateLabels(name, data.start, data.end);
        showFeedback('‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#10b981');
    }
}

function generateLabels(name, start, end){
    updatePrintConfig(); // Sync size
    
    const mode = document.getElementById('printMode').value;
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î QR ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏ö‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢)
    const paperH = parseInt(document.getElementById('pHeight').value) || 30;
    const qrSize = (mode === 'Single') ? (paperH - 12) * 3.78 : 100; // ‡πÅ‡∏õ‡∏•‡∏á mm ‡πÄ‡∏õ‡πá‡∏ô pixel ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ

    for(let i = start; i <= end; i++){
        const num = String(i).padStart(3, '0');
        const machineCode = `${name}${SEPARATOR}${num}`;
        const humanText = `${name} (${num})`;

        const div = document.createElement('div');
        div.className = 'label-preview';
        
        div.innerHTML = `
            <div class="lbl-name">${name}</div>
            <div id="qr_${i}" class="qr-box"></div>
            <div class="lbl-code">${num}</div>
        `;
        els.printArea.appendChild(div);
        
        new QRCode(document.getElementById(`qr_${i}`), { 
            text: unescape(encodeURIComponent(machineCode)), 
            width: qrSize, height: qrSize, 
            correctLevel : QRCode.CorrectLevel.L 
        });
    }
    
    // Scroll ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Preview
    document.getElementById('printArea').scrollIntoView({behavior: "smooth"});
}

// ================= SCANNER LOGIC (Fixed) =================
let inputBufferTimer; let isBusy = false; let isCameraCooldown = false;

els.barcode.addEventListener('input', (e) => {
    if(isBusy) { els.barcode.value = ''; return; }
    clearTimeout(inputBufferTimer);
    inputBufferTimer = setTimeout(() => {
        let val = els.barcode.value.trim();
        if(val.length > 2) processScan(val, 'input');
    }, 500); 
});
els.barcode.addEventListener('keydown', (e) => { 
    if (e.key === 'Enter') { e.preventDefault(); clearTimeout(inputBufferTimer); processScan(els.barcode.value.trim(), 'input'); } 
});

async function processScan(code, source){
    if(isBusy) return;
    if(source === 'camera' && isCameraCooldown) return;

    let raw = decodeURIComponent(code);
    els.debug.innerText = `‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤: ${raw}`;
    
    isBusy = true; 
    let productKey = raw;
    
    // ‡πÅ‡∏¢‡∏Å ___
    if (raw.includes(SEPARATOR)) { productKey = raw.split(SEPARATOR)[0]; }
    else if(raw.length > 5 && !isNaN(raw) && !raw.includes('-')) { productKey = raw.substring(0, raw.length - 3); }

    showFeedback('‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', '#334155');
    els.barcode.disabled = true;

    try {
        const res = await fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'GET_PRODUCT', code: productKey, fullBarcode: raw }) });
        const data = await res.json();

        if(data.status !== 'success'){ 
            if(productKey !== raw){ // Retry
                 const res2 = await fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'GET_PRODUCT', code: raw, fullBarcode: raw }) });
                 const data2 = await res2.json();
                 if(data2.status === 'success'){ logSuccess(data2, raw, source); return; }
            }
            showFeedback('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '#ef4444'); els.debug.innerText += " (Not Found)";
        } else {
            logSuccess(data, raw, source);
        }
    } catch (err) { showFeedback('‚ö†Ô∏è Error', '#ef4444'); }
    finally {
        isBusy = false; els.barcode.value = ''; els.barcode.disabled = false;
        if(source === 'input') els.barcode.focus(); else els.barcode.blur();
        if(source === 'camera') { isCameraCooldown = true; setTimeout(() => { isCameraCooldown = false; }, 3000); }
    }
}

function logSuccess(data, raw, source){
    let action = (data.last_action === 'IN') ? 'OUT' : 'IN';
    fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'LOG', barcode: raw, name: data.full_name, action: action, fixedCode: data.code }) });
    logs.unshift({ time: Date.now(), barcode: raw, name: data.full_name, action: action });
    if(logs.length > 50) logs.pop();
    localStorage.setItem('logs_s4', JSON.stringify(logs));
    renderLogs();
    
    let color = action==='IN'?'#10b981':'#ef4444';
    let msg = `‚úÖ ${action}: ${data.full_name}`;
    if(source === 'camera') msg += "<br><small>(‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á 3 ‡∏ß‡∏¥)</small>";
    showFeedback(msg, color);
    els.debug.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
}

function renderLogs(){
    if(logs.length === 0) { els.stock.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#94a3b8;">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</td></tr>'; return; }
    els.stock.innerHTML = logs.map(l => `<tr><td style="color:#64748b; font-size:0.8rem;">${new Date(l.time).toLocaleTimeString('th-TH')}</td><td><div style="font-weight:600; font-size:0.9rem;">${l.name}</div><div style="font-size:0.75rem; color:#94a3b8;">${l.barcode}</div></td><td><span class="badge ${l.action==='IN'?'badge-in':'badge-out'}">${l.action}</span></td></tr>`).join('');
}
function clearData(){ if(confirm('‡∏•‡πâ‡∏≤‡∏á?')){ logs=[]; localStorage.removeItem('logs_s4'); renderLogs(); } }
function showFeedback(text, color){ 
    els.feedback.innerHTML = text; els.feedback.style.background = color; 
    els.feedback.style.opacity = 1; els.feedback.style.bottom = "50px"; 
    setTimeout(() => { els.feedback.style.opacity = 0; els.feedback.style.bottom = "30px"; }, 2000); 
}

// Camera
let html5QrcodeScanner = null;
function toggleCamera(){
    const reader = document.getElementById('reader');
    const btn = document.getElementById('btnCamToggle');
    if(html5QrcodeScanner){
        html5QrcodeScanner.clear().then(_ => { reader.style.display = 'none'; btn.innerText = '‡∏Å‡∏•‡πâ‡∏≠‡∏á'; btn.style.background = '#10b981'; html5QrcodeScanner = null; });
    } else {
        els.barcode.blur();
        reader.style.display = 'block'; btn.innerText = '‡∏õ‡∏¥‡∏î'; btn.style.background = '#ef4444';
        html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render((decodedText)=>{ processScan(decodedText, 'camera'); });
    }
}

renderLogs();
</script>
</body>
</html>
