<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Stock Barcode (S4 System)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
/* CSS ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á */
body { font-family: 'Sarabun', sans-serif; background:#f1f5f9; padding:20px; color:#333; max-width: 900px; margin: 0 auto; }
.card { background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
input { width:100%; padding:14px; font-size:16px; margin-top:8px; border:1px solid #ccc; border-radius:8px; box-sizing: border-box; }
input:focus { border-color: #2563eb; outline: none; }
button { padding:12px; border:none; border-radius:8px; font-size:16px; cursor:pointer; margin-top:10px; transition: 0.2s; }
button:hover { opacity: 0.9; }
.gen { background:#2563eb; color:#fff; }
.clear { background:#fee2e2; color:#dc2626; float:right; font-size:12px; padding:6px 12px; font-weight: bold; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
th { background-color: #f8fafc; font-weight: 600; color: #64748b; }
.in { color:#16a34a; font-weight:bold; background:#dcfce7; padding:2px 8px; border-radius:4px; font-size: 14px; }
.out { color:#dc2626; font-weight:bold; background:#fee2e2; padding:2px 8px; border-radius:4px; font-size: 14px; }

.labels { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin-top: 20px; }
.label { border: 2px dashed #cbd5e1; padding: 20px 10px; text-align: center; background: #fff; border-radius: 12px; width: fit-content; margin: auto; max-width: 100%; box-sizing: border-box; }
.label-name { font-weight:bold; margin-bottom:5px; font-size:18px; color: #1e40af; }
.label-code { font-size:14px; font-family:monospace; color:#333; margin-top:5px; font-weight: bold; }

#loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; text-align:center; padding-top:200px; font-size:24px; font-weight:bold; color:#2563eb; }

/* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á */
#cameraArea { 
    display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:#000; z-index:1000; 
}
#cameraStream { 
    width:100%; height:100%; object-fit:cover; 
}
.camera-ui-layer {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
    display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box;
}
.close-cam {
    background: #dc2626; color: white; padding: 15px 30px; border-radius: 30px; font-weight: bold; font-size: 18px;
    align-self: center; pointer-events: auto; margin-bottom: 20px;
}
.scan-line {
    position: absolute; top: 40%; left: 10%; width: 80%; height: 2px; background: red; box-shadow: 0 0 10px red;
    animation: scanMove 2s infinite;
}
@keyframes scanMove { 0% {top:30%} 50% {top:50%} 100% {top:30%} }

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á‡∏ï‡∏¥‡∏î */
#scanFeedback {
    background: rgba(22, 163, 74, 0.9);
    color: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s;
    margin-top: 50px;
}

@media print {
  body * { visibility:hidden }
  #printArea, #printArea * { visibility:visible }
  #printArea { position:absolute; top:0; left:0; width:100%; margin:0; padding:10px; }
  .labels { display:block; }
  .label { display:inline-block; width: auto; min-width: 45%; margin: 10px; border: 2px solid #000; page-break-inside:avoid; padding: 15px; }
}
</style>
</head>

<body>

<div id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

<div id="cameraArea">
    <div id="cameraStream"></div>
    <div class="scan-line"></div>
    
    <div class="camera-ui-layer">
        <div id="scanFeedback">‡∏£‡∏´‡∏±‡∏™: -</div>
        <button class="close-cam" onclick="stopCamera()">‚ùå ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)</button>
    </div>
</div>

<h2>üì¶ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ - ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å S4</h2>

<div class="card" style="border-top: 4px solid #2563eb;">
  <label style="font-weight:bold">1. ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏¥‡∏á‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ</label>
  <input id="productName" placeholder="‡∏£‡∏´‡∏±‡∏™">
  
  <label style="display:block; margin-top:15px; font-weight:bold">2. ‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥</label>
  <div style="display:flex; gap:10px">
      <input id="barcode" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå..." autofocus>
      <button onclick="startCamera()" style="margin-top:8px; background:#16a34a; white-space:nowrap; color:white">üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
  </div>
</div>

<div class="card">
  <h3 style="margin-top:0">
    üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 
    <button class="clear" onclick="clearData()">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
  </h3>
  <table>
    <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡∏á</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
    <tbody id="stock"></tbody>
  </table>
</div>

<hr style="border:0; border-top:1px dashed #ccc; margin: 30px 0;">

<h2>üè∑Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á Barcode (‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</h2>
<div class="card">
  <div style="display:flex; gap:10px;">
     <div style="flex:2">
        <label style="font-size:12px; font-weight:bold;">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
        <input id="genName" placeholder="18802" style="margin-top:5px">
     </div>
     <div style="flex:2">
        <label style="font-size:12px; font-weight:bold;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Prefix)</label>
        <input id="genPrefix" placeholder="‡πÄ‡∏ä‡πà‡∏ô 310169" style="margin-top:5px">
     </div>
     <div style="flex:1">
        <label style="font-size:12px; font-weight:bold;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
        <input id="genQty" type="number" value="10" placeholder="10" style="margin-top:5px">
     </div>
  </div>
  <br>
  <div style="display:flex; gap:10px;">
    <button class="gen" onclick="requestBarcodes()" style="width:100%">‚òÅÔ∏è ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å Server</button>
    <button class="gen" style="background:#475569; width:100%" onclick="window.print()">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>
  </div>
</div>

<div class="card" id="printArea"><div class="labels" id="labels"></div></div>

<script>
// ===== CONFIG =====
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbyxwLZBm_oYk7U9wO82vE_1aaQ4i4jOHgKkbkK-xVX3GbOsH7rwy_KtTsoDQi_ekHHF/exec'; 

// ===== State =====
let logs = JSON.parse(localStorage.getItem('logs_team') || '[]');

// ===== Elements =====
const barcodeInput = document.getElementById('barcode');
const productNameInput = document.getElementById('productName');
const stockEl = document.getElementById('stock');
const loadingEl = document.getElementById('loading');
const cameraArea = document.getElementById('cameraArea');
const feedbackEl = document.getElementById('scanFeedback');

// ===== LOGIC: ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ =====
barcodeInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') processBarcode(); });
barcodeInput.addEventListener('input', () => { if (barcodeInput.value.endsWith('!')) processBarcode(); });

function processBarcode(scannedValue = null) {
  let rawCode = scannedValue ? scannedValue : barcodeInput.value.replace(/!/g, '').trim();
  const nameInput = productNameInput.value.trim();

  if (!rawCode) return; 

  let currentName = nameInput;
  if (!currentName && rawCode.includes('-')) {
      currentName = rawCode.split('-')[0];
  }
  if (!currentName) {
    let existingItem = logs.find(l => l.barcode === rawCode);
    if (existingItem) currentName = existingItem.name;
    else { 
        alert('‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà! ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô'); 
        barcodeInput.value=''; 
        return; 
    }
  }

  if(!productNameInput.value) productNameInput.value = currentName;

  const lastActionLog = [...logs].reverse().find(l => l.barcode === rawCode);
  const action = (lastActionLog && lastActionLog.action === 'IN') ? 'OUT' : 'IN';

  const record = { barcode: rawCode, name: currentName, action: action, time: Date.now() };
  logs.push(record);
  
  sendToSheet({ barcode: rawCode, name: currentName, action: action });
  playSound();

  barcodeInput.value = ''; 
  barcodeInput.focus(); 
  saveAndRender();

  return `${rawCode} (${action})`;
}

function sendToSheet(data) {
  try {
    fetch(SHEET_URL, {
      method: 'POST', mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(data)
    });
  } catch (e) { console.error(e); }
}

async function requestBarcodes() {
  const name = document.getElementById('genName').value.trim();
  const prefix = document.getElementById('genPrefix').value.trim();
  const qty = parseInt(document.getElementById('genQty').value);

  if (!name || !prefix || qty <= 0) { alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ + ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }

  loadingEl.style.display = 'block';

  try {
    const response = await fetch(SHEET_URL, {
      method: 'POST', redirect: "follow",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ actionType: 'GENERATE', name: name, prefix: prefix, qty: qty })
    });
    
    const result = await response.json();
    loadingEl.style.display = 'none';

    if(result.status === 'success'){
        renderBarcodes(name, prefix, result.start, result.end);
    } else {
        alert('Error: ' + result.message);
    }
  } catch (e) {
    loadingEl.style.display = 'none';
    alert('Connect Error: ' + e);
  }
}

function renderBarcodes(name, prefix, start, end) {
  const labels = document.getElementById('labels');
  labels.innerHTML = '';
  let count = 0;
  for (let i = start; i <= end; i++) {
    const runningNum = String(i).padStart(3, '0');
    const fullCode = `${name}-${prefix}${runningNum}`; 
    const barcodeValue = fullCode + '!'; 
    const div = document.createElement('div');
    div.className = 'label';
    div.innerHTML = `<div class="label-name">${name}</div><svg id="bc${count}"></svg><div class="label-code">${fullCode}</div>`;
    labels.appendChild(div);
    try { JsBarcode(`#bc${count}`, barcodeValue, { format: 'CODE128', width: 2, height: 50, margin: 5, displayValue: false }); } catch(err){}
    count++;
  }
}

function saveAndRender() {
  localStorage.setItem('logs_team', JSON.stringify(logs));
  stockEl.innerHTML = '';
  [...logs].sort((a,b) => b.time - a.time).slice(0, 10).forEach(r => {
      const date = new Date(r.time);
      stockEl.innerHTML += `<tr><td style="color:#666; font-size:12px">${date.toLocaleTimeString('th-TH')}</td><td style="font-family:monospace; font-weight:bold">${r.barcode}</td><td>${r.name}</td><td><span class="${r.action === 'IN' ? 'in' : 'out'}">${r.action}</span></td></tr>`;
  });
}
function clearData() { if(confirm('‡∏•‡∏ö‡∏à‡∏≠?')) { logs = []; saveAndRender(); } }

// ===== CAMERA LOGIC (Continuous) =====
let lastScannedCode = "";
let lastScannedTime = 0;

function startCamera() {
    cameraArea.style.display = 'block';
    
    Quagga.init({
        inputStream : {
            name : "Live",
            type : "LiveStream",
            target: document.querySelector('#cameraStream'), 
            constraints: {
                width: { min: 640 },
                height: { min: 480 },
                facingMode: "environment", 
                aspectRatio: { min: 1, max: 2 }
            }
        },
        decoder : { readers : ["code_128_reader"] },
        locate: true 
    }, function(err) {
        if (err) {
            console.log(err);
            alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err);
            stopCamera();
            return;
        }
        Quagga.start();
    });

    Quagga.onDetected(function(result) {
        var code = result.codeResult.code;
        var currentTime = Date.now();

        // DEBOUNCE: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏° ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        if (code === lastScannedCode && (currentTime - lastScannedTime < 2000)) {
            return; 
        }

        if(code && code.length > 3) {
            lastScannedCode = code;
            lastScannedTime = currentTime;

            let status = processBarcode(code); 
            if(status) showScanFeedback(status);
        }
    });
}

function showScanFeedback(text) {
    feedbackEl.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + text;
    feedbackEl.style.opacity = "1";
    setTimeout(() => { feedbackEl.style.opacity = "0"; }, 1500);
}

function stopCamera() {
    Quagga.stop();
    cameraArea.style.display = 'none';
    lastScannedCode = ""; 
}

function playSound() {
    const context = new (window.AudioContext || window.webkitAudioContext)();
    const osc = context.createOscillator();
    const gain = context.createGain();
    osc.connect(gain);
    gain.connect(context.destination);
    osc.frequency.value = 1500;
    gain.gain.value = 0.1;
    osc.start();
    setTimeout(() => osc.stop(), 100);
}

saveAndRender();
</script>

</body>
</html>