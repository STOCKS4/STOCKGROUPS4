<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>S4 Inventory (QR Code Edition)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Sarabun:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

<style>
/* ====== 1. SYSTEM THEME ====== */
:root {
    --primary: #0f172a;       /* Navy Blue */
    --accent: #2563eb;        /* Royal Blue */
    --bg-body: #f8fafc;       
    --text-main: #334155;
    --border: #e2e8f0;
}
body { font-family: 'Inter', 'Sarabun', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; line-height: 1.5; }

/* Layout */
header {
    background: var(--primary); color: white; padding: 1rem 1.5rem;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
}
.brand { font-weight: 700; font-size: 1.25rem; display: flex; align-items: center; gap: 8px; }
.status-badge { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }

.container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display: grid; grid-template-columns: 1fr 350px; gap: 24px; }
@media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

/* Cards */
.card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
.card-header { padding: 1rem 1.5rem; background: #fff; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
.card-body { padding: 1.5rem; }

/* Form Elements */
input, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; box-sizing: border-box; font-size: 0.95rem; }
label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: #64748b; }

/* Buttons */
.btn { width: 100%; padding: 0.75rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; color: white; font-size: 0.95rem; display: flex; justify-content: center; align-items: center; gap: 8px;}
.btn-primary { background: var(--accent); } .btn-primary:hover { background: #1d4ed8; }
.btn-dark { background: var(--primary); } .btn-dark:hover { background: #1e293b; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: #64748b; width: auto; padding: 0.4rem 1rem; font-size: 0.85rem; }
.btn-outline:hover { background: #f1f5f9; color: #ef4444; border-color: #fecaca; }
.btn-scan { background: #10b981; width: auto; padding: 0 1.5rem; }

/* Table */
.table-responsive { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #f1f5f9; }
th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }
.code-text { font-family: 'Roboto Mono', monospace; font-weight: 700; color: var(--primary); }
.badge-in { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; } 
.badge-out { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }

/* ====== 2. QR PREVIEW UI ====== */
.settings-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed var(--border); margin-bottom: 20px; }
.row { display: flex; gap: 10px; } .col { flex: 1; }

.labels-container { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR */
    gap: 15px; margin-top: 10px; 
}
.label-item { 
    background: white; border: 1px solid var(--border); border-radius: 8px; padding: 15px; text-align: center; 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    aspect-ratio: 1 / 1.2; /* ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ô‡∏¥‡∏î‡πÜ */
}
/* QR Code Image Style */
.label-item img { max-width: 100%; height: auto; mix-blend-mode: multiply; }
.lbl-name { font-weight: 700; margin-bottom: 8px; color: var(--primary); font-size: 0.9rem; line-height: 1.2; }
.lbl-code { font-family: 'Roboto Mono', monospace; font-size: 0.75rem; color: #64748b; font-weight: 600; margin-top: 5px; }

/* Camera Overlay */
#reader { width: 100%; border-radius: 12px; overflow: hidden; margin-top: 20px; display: none; border: 2px solid var(--accent); }
#scanFeedback { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000; font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

/* ====== 3. PRINT ENGINE (QR EDITION) ====== */
@media print {
    body { background: white; margin: 0; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    header, .container, #scanFeedback, #reader { display: none !important; }
    #printArea { display: block !important; position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 0; }

    /* A4 MODE: GRID */
    .mode-a4 .labels-container {
        display: grid !important;
        grid-template-columns: repeat(5, 1fr) !important; /* QR ‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ‡πÄ‡∏•‡∏¢‡∏ß‡∏≤‡∏á 5 ‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ */
        gap: 10px 10px !important;
        padding: 10px !important;
    }
    .mode-a4 .label-item {
        border: 1px dashed #cbd5e1 !important;
        break-inside: avoid !important;
        page-break-inside: avoid !important;
        margin: 0 !important;
        height: auto !important;
        box-shadow: none !important;
    }

    /* THERMAL MODE: PAGE BREAK */
    .mode-single .labels-container { display: block !important; }
    .mode-single .label-item {
        border: none !important;
        page-break-after: always !important;
        break-after: page !important;
        margin: 0 auto !important;
        width: 100% !important;
        height: 100% !important;
        display: flex; justify-content: center; align-items: center;
    }
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î QR ‡∏ï‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô Thermal ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
    .mode-single .label-item img { width: 70% !important; height: auto !important; }
}
</style>
</head>
<body>

<header>
    <div class="brand">üì¶ S4 Inventory <span style="font-size:0.7em; background:white; color:var(--primary); padding:2px 6px; border-radius:4px; margin-left:5px;">QR</span></div>
    <div class="status-badge">üü¢ System Online</div>
</header>

<div class="container">
    
    <div>
        <div class="card">
            <div class="card-header">üì∑ Scan QR / Barcode</div>
            <div class="card-body">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex-grow:1;">
                        <input id="barcode" placeholder="Click to focus input..." autofocus>
                    </div>
                    <button class="btn btn-scan" id="btnCamToggle" onclick="toggleCamera()">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                </div>
                <div id="reader"></div> <div style="font-size:0.8rem; color:#64748b; margin-top:5px;">* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á QR Code ‡πÅ‡∏•‡∏∞ Barcode ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                üìã Activity Log
                <button class="btn-outline" onclick="clearData()">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
            <div class="table-responsive">
                <table>
                    <thead><tr><th width="25%">Time</th><th width="55%">Product</th><th width="20%">Status</th></tr></thead>
                    <tbody id="stock"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div>
        <div class="card" style="position:sticky; top:100px;">
            <div class="card-header">üñ®Ô∏è QR Generator</div>
            <div class="card-body">
                
                <div class="settings-box">
                    <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</label>
                    <select id="printMode" onchange="updatePrintConfig()">
                        <option value="A4">üìÑ A4 Paper (‡∏ï‡∏≤‡∏£‡∏≤‡∏á 5x)</option>
                        <option value="Single">üßª Thermal Roll (‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß)</option>
                    </select>

                    <div id="sizeInputs" class="row" style="display:none; align-items: flex-end;">
                        <div class="col"><label>W (mm)</label><input id="pWidth" type="number" value="50"></div>
                        <div style="padding-bottom:25px; color:#94a3b8;">x</div>
                        <div class="col"><label>H (mm)</label><input id="pHeight" type="number" value="50"></div> </div>
                </div>

                <div class="row">
                    <div class="col-2"><label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="genName" placeholder="‡πÄ‡∏ä‡πà‡∏ô 18802"></div>
                    <div class="col"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input id="genQty" type="number" value="10"></div>
                </div>

                <div class="row" style="margin-top:10px;">
                    <button class="btn btn-primary" onclick="requestBarcodes()">‡∏™‡∏£‡πâ‡∏≤‡∏á QR</button>
                    <button class="btn btn-dark" onclick="window.print()">‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>
                </div>

            </div>
        </div>
    </div>

</div>

<div id="printArea">
    <div id="labelsContainer" class="labels-container"></div>
    <div id="emptyMsg" style="text-align:center; padding:50px; color:#cbd5e1;">(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ QR Code)</div>
</div>

<div id="scanFeedback"></div>

<script>
// ================= CONFIG =================
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxlC36QoUV37QvM6fazvGOlf5daaHrmdVTjQuHqpRnX_kTOFt7q3JbjwZ7H-rHBM00/exec';
let logs = JSON.parse(localStorage.getItem('logs_s4') || '[]');
const els = { 
    barcode: document.getElementById('barcode'), 
    stock: document.getElementById('stock'), 
    container: document.getElementById('labelsContainer'), 
    printArea: document.getElementById('printArea'), 
    feedback: document.getElementById('scanFeedback') 
};

// Restore Settings
if(localStorage.getItem('print_w')) document.getElementById('pWidth').value = localStorage.getItem('print_w');
if(localStorage.getItem('print_h')) document.getElementById('pHeight').value = localStorage.getItem('print_h');
if(localStorage.getItem('print_mode')) document.getElementById('printMode').value = localStorage.getItem('print_mode');

// ================= PRINT ENGINE =================
function updatePrintConfig(){
    const mode = document.getElementById('printMode').value;
    const w = document.getElementById('pWidth').value || 50;
    const h = document.getElementById('pHeight').value || 50; // Default Square for QR
    
    document.getElementById('sizeInputs').style.display = (mode === 'Single') ? 'flex' : 'none';
    els.printArea.className = (mode === 'Single') ? 'mode-single' : 'mode-a4';
    
    const styleId = 'dynamic-page-size';
    let styleTag = document.getElementById(styleId);
    if(styleTag) styleTag.remove();
    
    styleTag = document.createElement('style');
    styleTag.id = styleId;
    if(mode === 'Single'){
        styleTag.innerHTML = `@media print { @page { size: ${w}mm ${h}mm; margin: 0; } }`;
    } else {
        styleTag.innerHTML = `@media print { @page { size: A4; margin: 0.5cm; } }`;
    }
    document.head.appendChild(styleTag);

    localStorage.setItem('print_mode', mode); localStorage.setItem('print_w', w); localStorage.setItem('print_h', h);
}
document.getElementById('pWidth').addEventListener('input', updatePrintConfig);
document.getElementById('pHeight').addEventListener('input', updatePrintConfig);
updatePrintConfig();

// ================= SCAN LOGIC =================
els.barcode.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); processScan(); } });

async function processScan(code=null){
    let raw = code || els.barcode.value.replace(/\s/g,'').trim();
    if(!raw) return;

    let productKey = raw;
    // Logic ‡∏ï‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô 3 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°)
    // 18802282 -> 18802
    if(raw.length > 5 && !isNaN(raw) && !raw.includes('-')) { 
         // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô format ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏à‡∏ô‡πÄ‡∏≠‡∏á (‡∏£‡∏´‡∏±‡∏™+3‡∏´‡∏•‡∏±‡∏Å)
         // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™ S4 ‡πÑ‡∏´‡∏° (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß)
         // ‡πÅ‡∏ï‡πà‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ logic ‡πÄ‡∏î‡∏¥‡∏° ‡∏Ñ‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡∏¢‡∏≤‡∏ß‡πÜ ‡∏ï‡∏±‡∏î 3 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å
         productKey = raw.substring(0, raw.length - 3);
    } 
    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ç‡∏µ‡∏î (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤)
    else if(raw.includes('-')) {
         productKey = raw.split('-')[0];
    }

    showFeedback('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', '#334155');

    try {
        const res = await fetch(SHEET_URL, {
            method: 'POST', body: JSON.stringify({ actionType: 'GET_PRODUCT', code: productKey, fullBarcode: raw })
        });
        const data = await res.json();

        if(data.status !== 'success'){
            // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏ï‡πá‡∏°‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á)
            if(productKey !== raw){
                 const res2 = await fetch(SHEET_URL, {
                    method: 'POST', body: JSON.stringify({ actionType: 'GET_PRODUCT', code: raw, fullBarcode: raw })
                });
                const data2 = await res2.json();
                if(data2.status === 'success'){
                    logSuccess(data2, raw); return;
                }
            }
            showFeedback('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '#ef4444'); els.barcode.value = ''; return;
        }

        logSuccess(data, raw);

    } catch (err) { showFeedback('‚ö†Ô∏è Server Error', '#ef4444'); }
}

function logSuccess(data, raw){
    let action = (data.last_action === 'IN') ? 'OUT' : 'IN';
    fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'LOG', barcode: raw, name: data.full_name, action: action, fixedCode: data.code }) });

    logs.unshift({ time: Date.now(), barcode: raw, name: data.full_name, action: action });
    if(logs.length > 50) logs.pop();
    localStorage.setItem('logs_s4', JSON.stringify(logs));
    renderLogs();
    
    els.barcode.value = '';
    showFeedback(`‚úÖ ${action}: ${data.full_name}`, action==='IN'?'#10b981':'#ef4444');
}

function renderLogs(){
    if(logs.length === 0) { els.stock.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#94a3b8;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>'; return; }
    els.stock.innerHTML = logs.map(l => `
        <tr>
            <td style="color:#64748b; font-size:0.85rem;">${new Date(l.time).toLocaleTimeString('th-TH')}</td>
            <td><div style="font-weight:600; color:#0f172a;">${l.name}</div><div class="code-text">${l.barcode}</div></td>
            <td><span class="${l.action === 'IN' ? 'badge-in' : 'badge-out'}">${l.action}</span></td>
        </tr>`).join('');
}
function clearData(){ if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?')){ logs=[]; localStorage.removeItem('logs_s4'); renderLogs(); } }
function showFeedback(text, color){ 
    els.feedback.innerText = text; els.feedback.style.background = color; 
    els.feedback.style.opacity = 1; els.feedback.style.bottom = "50px"; 
    setTimeout(() => { els.feedback.style.opacity = 0; els.feedback.style.bottom = "30px"; }, 2000); 
}

// ================= QR GENERATOR LOGIC =================
async function requestBarcodes(){
    const name = document.getElementById('genName').value.trim();
    const qty = parseInt(document.getElementById('genQty').value);
    if(!name || qty <= 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    
    showFeedback('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á QR...', '#334155');
    document.getElementById('emptyMsg').style.display = 'none';

    // ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç
    const res = await fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'GENERATE', name: name, qty: qty }) });
    const data = await res.json();
    
    if(data.status === 'success'){ 
        generateLabels(name, data.start, data.end); 
        showFeedback('‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '#10b981');
    }
}

function generateLabels(name, start, end){
    els.container.innerHTML = '';
    const mode = document.getElementById('printMode').value;
    const w = document.getElementById('pWidth').value;
    const h = document.getElementById('pHeight').value;
    
    updatePrintConfig(); 

    for(let i = start; i <= end; i++){
        const num = String(i).padStart(3, '0');
        // Machine Code: ‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢ 18802282 (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏µ‡∏î) QR ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏™‡∏ö‡∏≤‡∏¢
        const machineCode = `${name}${num}`; 
        const humanText = `${name}-${num}`;

        const div = document.createElement('div');
        div.className = 'label-item';
        
        // Show real size on screen if Thermal
        if(mode === 'Single'){ div.style.width = w + 'mm'; div.style.height = h + 'mm'; }

        // Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR Code
        const qrDiv = document.createElement('div');
        qrDiv.id = `qr_${i}`;
        
        div.innerHTML = `<div class="lbl-name">${name}</div>`;
        div.appendChild(qrDiv);
        div.innerHTML += `<div class="lbl-code">${humanText}</div>`;
        
        els.container.appendChild(div);

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code
        new QRCode(qrDiv, {
            text: machineCode,
            width: (mode === 'Single' ? 100 : 80), // ‡∏Ç‡∏ô‡∏≤‡∏î QR
            height: (mode === 'Single' ? 100 : 80),
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
    }
}

// ================= NEW CAMERA ENGINE (Html5Qrcode) =================
let html5QrcodeScanner = null;

function toggleCamera(){
    const reader = document.getElementById('reader');
    const btn = document.getElementById('btnCamToggle');
    
    if(html5QrcodeScanner){
        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        html5QrcodeScanner.clear().then(_ => {
            reader.style.display = 'none';
            btn.innerText = '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
            btn.style.background = '#10b981';
            html5QrcodeScanner = null;
        });
    } else {
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        reader.style.display = 'block';
        btn.innerText = '‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
        btn.style.background = '#ef4444';
        
        html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess);
    }
}

function onScanSuccess(decodedText, decodedResult) {
    // ‡∏Å‡∏±‡∏ô‡∏¢‡∏¥‡∏á‡∏£‡∏±‡∏ß (Debounce)
    if(document.getElementById('barcode').value === decodedText) return;
    
    processScan(decodedText);
    
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏à‡∏≠ (Optional: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å)
    // toggleCamera(); 
}

// Init
renderLogs();
</script>
</body>
</html>
