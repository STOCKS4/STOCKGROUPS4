<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Stock Barcode (S4 System)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
/* ====== CSS ‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á UI) ====== */
body { font-family: 'Sarabun', sans-serif; background:#f1f5f9; padding:20px; color:#333; max-width: 900px; margin: 0 auto; }
.card { background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
input { width:100%; padding:14px; font-size:16px; margin-top:8px; border:1px solid #ccc; border-radius:8px; }
button { padding:12px; border:none; border-radius:8px; font-size:16px; cursor:pointer; margin-top:10px; }
.gen { background:#2563eb; color:#fff; }
.clear { background:#fee2e2; color:#dc2626; float:right; font-size:12px; padding:6px 12px; font-weight:bold; }

table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { padding:10px; border-bottom:1px solid #eee; }
.in { color:#16a34a; font-weight:bold; background:#dcfce7; padding:2px 8px; border-radius:4px; }
.out { color:#dc2626; font-weight:bold; background:#fee2e2; padding:2px 8px; border-radius:4px; }

.labels { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:20px; margin-top:20px; }

.label { border:2px dashed #cbd5e1; padding:12px; text-align:center; border-radius:10px; background:#fff; page-break-inside: avoid; width:100%; box-sizing:border-box; overflow:hidden; }
.label-name { font-weight:bold; margin-bottom:6px; font-size:16px; color:#1e40af; }
.barcode-wrap{ width:100%; display:flex; justify-content:center; align-items:center; overflow:hidden; }
.label svg{ max-width:100%; height:auto; }
.label-code { font-size:12px; font-family:monospace; margin-top:6px; font-weight:bold; word-break: break-all; }

#loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; text-align:center; padding-top:200px; font-size:24px; font-weight:bold; color:#2563eb; }

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á CSS ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î */
#cameraArea { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; }
#cameraStream { width:100%; height:100%; object-fit:cover; }
.close-cam { position:absolute; top:20px; right:20px; background:red; color:white; padding:10px 20px; border-radius:30px; z-index:1001; font-weight:bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

.scan-line { position:absolute; top:40%; left:10%; width:80%; height:2px; background:red; animation:scanMove 2s infinite; }
@keyframes scanMove { 0%{top:30%}50%{top:50%}100%{top:30%} }

#scanFeedback { background:rgba(22,163,74,0.9); color:white; padding:15px; border-radius:10px; text-align:center; font-size:20px; font-weight:bold; opacity:0; transition:0.3s; margin-top:50px; }
</style>
</head>

<body>

<h2>üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô IN / OUT (CONNECTED PRODUCT_LIST)</h2>

<div class="card">
  <label><b>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -</b></label>

  <label style="margin-top:15px"><b>Barcode</b></label>
  <div style="display:flex; gap:10px">
    <input id="barcode" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î..." autofocus>
    <button onclick="startCamera()" style="background:#16a34a;color:white;">üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
  </div>
</div>

<div class="card">
  <h3>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <button class="clear" onclick="clearData()">‡∏•‡πâ‡∏≤‡∏á</button></h3>
  <table>
    <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>Barcode</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
    <tbody id="stock"></tbody>
  </table>
</div>

<hr>

<h2>üè∑Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á Barcode ‡πÅ‡∏¢‡∏Å‡∏ä‡∏¥‡πâ‡∏ô</h2>
<div class="card">
  <input id="genName" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô 18802">
  <input id="genPrefix" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô 310169">
  <input id="genQty" type="number" value="10">
  <button class="gen" onclick="requestBarcodes()">‚òÅÔ∏è ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å Server</button>
  <button class="gen" style="background:#475569" onclick="window.print()">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>
</div>

<div class="card" id="printArea">
  <div class="labels" id="labels"></div>
</div>

<div id="cameraArea">
    <button class="close-cam" onclick="stopCamera()">‚ùå ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
    <div id="cameraStream"></div>
</div>
<div style="position:fixed;bottom:50px;left:0;width:100%;display:flex;justify-content:center;z-index:1002;pointer-events:none;">
    <div id="scanFeedback"></div>
</div>

<script>
// ‚úÖ URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbycdoStZRSZEFJE3VsVMGgoYTcw6fhOLVNEylXfY0xavmbNB4WK8VFKvbm81oPxrXom/exec';

// ===== PRODUCT LIST SYSTEM (‡πÉ‡∏ä‡πâ Key ‡πÄ‡∏î‡∏¥‡∏° ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô) =====
let PRODUCT_MAP = {};
let logs = JSON.parse(localStorage.getItem('logs_team') || '[]');
let itemStatus = JSON.parse(localStorage.getItem('item_status') || '{}');

const barcodeInput = document.getElementById('barcode');
const productNameInput = document.getElementById('productName');
const stockEl = document.getElementById('stock');
const feedbackEl = document.getElementById('scanFeedback');

// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡πÄ‡∏û‡∏¥‡πà‡∏° Timeout ‡∏Å‡∏±‡∏ô‡∏¢‡∏¥‡∏á‡∏£‡∏±‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Debounce)
let inputTimeout;
barcodeInput.addEventListener('input', ()=>{
  clearTimeout(inputTimeout);
  inputTimeout = setTimeout(() => {
    if(barcodeInput.value.length > 5){
      processBarcode();
    }
  }, 200); // ‡∏£‡∏≠ 0.2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≠‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
});

// ===== MAIN FLOW =====
async function processBarcode(code=null){
  let raw = code || barcodeInput.value.replace('!','').trim();
  if(!raw) return;

  let productCode = raw.split('-')[0];
  productCode = productCode.split('_')[0];

  // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  try {
      const res = await fetch(SHEET_URL,{
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body:JSON.stringify({actionType:'GET_PRODUCT', code:productCode})
      });

      const data = await res.json();

      if(data.status !== 'success'){
        alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô PRODUCT_LIST : ' + productCode);
        barcodeInput.value='';
        return;
      }

      const fullName = data.full_name;
      let current = itemStatus[raw] || 'OUT';
      let action = current === 'IN' ? 'OUT' : 'IN';

      itemStatus[raw] = action;

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å History ‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏¥‡∏° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢)
      const record = { barcode:raw, name:fullName, action:action, time:Date.now() };
      logs.push(record);

      // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Sheet ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤ (‡∏•‡∏ö mode: no-cors ‡∏≠‡∏≠‡∏Å)
      // ‡πÉ‡∏™‡πà actionType: 'LOG' ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (Server ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
      fetch(SHEET_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
              actionType: 'LOG', 
              barcode: raw,
              name: fullName,
              action: action
          })
      }).then(r => console.log('Log sent')).catch(e => console.error('Log error', e));

      barcodeInput.value='';
      saveAndRender();
      let balanceMsg = "";
  if(data.balance !== undefined){
     // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° + action ‡πÉ‡∏´‡∏°‡πà)
     let newBalance = data.balance + (action === "IN" ? 1 : -1);
     balanceMsg = ` [‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${newBalance}]`;
  }
  
  showScanFeedback(`${fullName} (${action})${balanceMsg}`);

  } catch (err) {
      alert("‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + err);
  }
}

function saveAndRender(){
  localStorage.setItem('logs_team',JSON.stringify(logs));
  localStorage.setItem('item_status',JSON.stringify(itemStatus));

  stockEl.innerHTML='';
  [...logs].reverse().slice(0,15).forEach(r=>{
    const d=new Date(r.time);
    stockEl.innerHTML+=`<tr>
      <td>${d.toLocaleTimeString()}</td>
      <td style="font-family:monospace;font-weight:bold">${r.barcode}</td>
      <td>${r.name}</td>
      <td><span class="${r.action==='IN'?'in':'out'}">${r.action}</span></td>
    </tr>`;
  });
}

function clearData(){
  if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){
    logs=[]; itemStatus={};
    saveAndRender();
  }
}

/* ===== Barcode Generator ===== */
async function requestBarcodes(){
  const name=genName.value.trim();
  const prefix=genPrefix.value.trim();
  const qty=parseInt(genQty.value);
  if(!name||!prefix||qty<=0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

  const res=await fetch(SHEET_URL,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({actionType:'GENERATE',name,prefix,qty})
  });
  const data=await res.json();
  if(data.status==='success'){
    renderBarcodes(name,prefix,data.start,data.end);
  }
}

function renderBarcodes(name,prefix,start,end){
  labels.innerHTML='';
  let i=0;
  for(let n=start;n<=end;n++){
    const num=String(n).padStart(3,'0');
    const code=`${name}-${prefix}${num}!`;
    const div=document.createElement('div');
    div.className='label';
    div.innerHTML=`
      <div class="label-name">${name}</div>
      <div class="barcode-wrap">
        <svg id="bc${i}"></svg>
      </div>
      <div class="label-code">${code}</div>
    `;
    labels.appendChild(div);

    JsBarcode(`#bc${i}`, code, { format: 'CODE128', width: 1.5, height: 38, margin: 4, displayValue: false });
    i++;
  }
}

/* ===== CAMERA ===== */
let lastCode="", lastTime=0;
function startCamera(){
  const cameraArea = document.getElementById('cameraArea');
  const cameraStream = document.getElementById('cameraStream');
  cameraArea.style.display='block';

  Quagga.init({
    inputStream:{
        name:"Live",
        type:"LiveStream",
        target:cameraStream,
        constraints:{facingMode:"environment"}
    },
    decoder:{readers:["code_128_reader"]},
    locate:true
  }, function(err) {
      if (err) { console.log(err); return }
      Quagga.start();
  });

  Quagga.onDetected(r=>{
    const code=r.codeResult.code;
    const now=Date.now();
    if(code===lastCode && now-lastTime<2000) return;
    lastCode=code; lastTime=now;
    processBarcode(code.replace('!',''));
  });
}

// ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
function stopCamera(){ 
    Quagga.stop(); 
    document.getElementById('cameraArea').style.display='none'; 
}

function showScanFeedback(text){
  feedbackEl.innerText=text;
  feedbackEl.style.opacity=1;
  setTimeout(()=>feedbackEl.style.opacity=0,1500);
}

saveAndRender();
</script>

</body>
</html>