<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>S4 Professional Stock System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

<style>
/* ====== GLOBAL STYLE ====== */
:root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --bg: #f1f5f9; }
body { font-family: 'Sarabun', sans-serif; background: var(--bg); padding: 20px; color: #333; max-width: 800px; margin: 0 auto; }
* { box-sizing: border-box; }

/* Cards */
.card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
.card-header { font-size: 18px; font-weight: bold; color: var(--primary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

/* Forms */
input, select { width: 100%; padding: 12px; font-size: 16px; margin-top: 5px; border: 1px solid #cbd5e1; border-radius: 8px; transition: 0.2s; }
input:focus { outline: none; border-color: var(--primary); ring: 2px var(--primary); }
label { font-size: 14px; color: #64748b; font-weight: 600; margin-top: 10px; display: block; }

/* Buttons */
.btn-group { display: flex; gap: 10px; margin-top: 15px; }
button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; }
.btn-primary { background: var(--primary); }
.btn-print { background: #334155; }
.btn-cam { background: var(--success); width: auto; flex: none; padding: 0 20px; }
.btn-clear { background: #fee2e2; color: var(--danger); font-size: 12px; padding: 5px 10px; flex: none; border-radius: 6px; }
button:active { transform: scale(0.98); }

/* Table */
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th { text-align: left; color: #64748b; font-size: 13px; padding: 8px; border-bottom: 2px solid #e2e8f0; }
td { padding: 10px 8px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
.badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; }
.badge.in { background: #dcfce7; color: var(--success); }
.badge.out { background: #fee2e2; color: var(--danger); }

/* Print Settings Area */
.settings-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed #cbd5e1; margin-bottom: 15px; }
.row-input { display: flex; gap: 10px; }

/* ====== BARCODE PREVIEW AREA ====== */
.labels { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
.label { 
    background: white; border: 1px solid #e2e8f0; border-radius: 8px; 
    padding: 10px; text-align: center; overflow: hidden;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.label-name { font-weight: bold; font-size: 16px; color: #0f172a; margin-bottom: 2px; line-height: 1.2; }
.label-code { font-family: 'Roboto Mono', monospace; font-size: 14px; color: #334155; margin-top: 2px; letter-spacing: 1px; }
.label svg { display: block; max-width: 100%; height: auto; }

/* Feedback & Camera */
#scanFeedback { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
#cameraArea { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; }
#cameraStream { width: 100%; height: 100%; object-fit: cover; }
.close-cam { position: absolute; top: 20px; right: 20px; background: rgba(255,0,0,0.8); color: white; z-index: 1001; border-radius: 50px; width: auto; }

/* ====== PRINT MODE (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ====== */
@media print {
    body * { visibility: hidden; }
    #printArea, #printArea * { visibility: visible; }
    #printArea { position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 0; background: white; box-shadow: none; border: none; }
    
    /* Reset Grid for Print */
    .labels { display: block; }
    .label { 
        border: none !important; 
        page-break-after: always; /* ‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏î‡∏ß‡∏á */
        margin: 0 auto; 
    }
    
    /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î */
    @page { margin: 0; size: auto; }
}
</style>
</head>
<body>

<div style="text-align:center; margin-bottom:20px;">
    <h2 style="margin:0; color:#1e293b;">üì¶ S4 Professional Stock</h2>
    <span style="font-size:12px; color:#64748b;">Version 3.0 (Stable & Auto-Running)</span>
</div>

<div class="card">
    <div class="card-header">üìç ‡∏à‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
    <div style="display:flex; gap:10px;">
        <input id="barcode" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." autofocus>
        <button class="btn-cam" onclick="startCamera()">üì∑</button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        ‚è≥ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 
        <button class="btn-clear" onclick="clearData()">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
    </div>
    <table>
        <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
        <tbody id="stock"></tbody>
    </table>
</div>

<div class="card">
    <div class="card-header">üñ®Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (Auto-Run)</div>
    
    <div class="settings-box">
        <label>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
        <div class="row-input">
            <select id="printMode" onchange="toggleSettings()">
                <option value="Single">Thermal (‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏°‡πâ‡∏ß‡∏ô)</option>
                <option value="A4">A4 (‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
            </select>
            <div id="sizeInputs" style="display:flex; gap:5px; flex:1;">
                <input id="pWidth" type="number" placeholder="W" value="50">
                <span style="align-self:center; font-size:12px;">x</span>
                <input id="pHeight" type="number" placeholder="H" value="30">
                <span style="align-self:center; font-size:12px;">mm</span>
            </div>
        </div>
    </div>

    <div class="row-input">
        <div style="flex:2;">
            <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Key)</label>
            <input id="genName" placeholder="‡πÄ‡∏ä‡πà‡∏ô 18802">
        </div>
        <div style="flex:1;">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
            <input id="genQty" type="number" value="10">
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-primary" onclick="requestBarcodes()">‚òÅÔ∏è ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç (Server)</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
    </div>
</div>

<div id="printArea">
    <div class="labels" id="labels"></div>
</div>

<div id="cameraArea">
    <button class="close-cam" onclick="stopCamera()">‚ùå ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
    <div id="cameraStream"></div>
</div>
<div id="scanFeedback"></div>

<script>
// ================= CONFIGURATION =================
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxlC36QoUV37QvM6fazvGOlf5daaHrmdVTjQuHqpRnX_kTOFt7q3JbjwZ7H-rHBM00/exec'; // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢

// ================= STATE MANAGEMENT =================
let logs = JSON.parse(localStorage.getItem('logs_s4') || '[]');
const els = {
    barcode: document.getElementById('barcode'),
    stock: document.getElementById('stock'),
    labels: document.getElementById('labels'),
    feedback: document.getElementById('scanFeedback'),
    // Settings
    mode: document.getElementById('printMode'),
    w: document.getElementById('pWidth'),
    h: document.getElementById('pHeight')
};

// Load Saved Settings
window.onload = () => {
    if(localStorage.getItem('print_mode')) els.mode.value = localStorage.getItem('print_mode');
    if(localStorage.getItem('print_w')) els.w.value = localStorage.getItem('print_w');
    if(localStorage.getItem('print_h')) els.h.value = localStorage.getItem('print_h');
    toggleSettings();
    renderLogs();
};

function saveSettings(){
    localStorage.setItem('print_mode', els.mode.value);
    localStorage.setItem('print_w', els.w.value);
    localStorage.setItem('print_h', els.h.value);
}

function toggleSettings(){
    const isSingle = els.mode.value === 'Single';
    document.getElementById('sizeInputs').style.visibility = isSingle ? 'visible' : 'hidden';
    saveSettings();
}

els.mode.addEventListener('change', toggleSettings);
els.w.addEventListener('input', saveSettings);
els.h.addEventListener('input', saveSettings);

// ================= SCAN LOGIC =================
els.barcode.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); processScan(); }
});

async function processScan(code=null){
    let raw = code || els.barcode.value.replace(/!/g,'').trim();
    if(!raw) return;

    // Logic: ‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (18802-0001 -> 18802)
    let productKey = raw.split('-')[0].split('_')[0];

    showFeedback('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', '#2563eb');
    
    try {
        const res = await fetch(SHEET_URL, {
            method: 'POST',
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            body: JSON.stringify({ actionType: 'GET_PRODUCT', code: productKey, fullBarcode: raw })
        });
        const data = await res.json();

        if(data.status !== 'success'){
            showFeedback('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '#dc2626');
            new Audio('https://www.soundjay.com/buttons/sounds/button-10.mp3').play(); // Error Sound
            els.barcode.value = '';
            return;
        }

        // Toggle Status
        let lastAction = data.last_action || 'OUT';
        let newAction = (lastAction === 'IN') ? 'OUT' : 'IN';

        // Log to Server
        fetch(SHEET_URL, {
            method: 'POST',
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            body: JSON.stringify({ 
                actionType: 'LOG', 
                barcode: raw, 
                name: data.full_name, 
                action: newAction, 
                fixedCode: data.code // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏°‡∏µ 0 ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≤‡∏Å Server
            })
        });

        // Update UI
        logs.unshift({ time: Date.now(), barcode: raw, name: data.full_name, action: newAction });
        if(logs.length > 20) logs.pop();
        localStorage.setItem('logs_s4', JSON.stringify(logs));
        
        renderLogs();
        els.barcode.value = '';
        showFeedback(`‚úÖ ${newAction}: ${data.full_name}`, newAction==='IN'?'#16a34a':'#dc2626');

    } catch (err) {
        showFeedback('‚ö†Ô∏è Server Error', '#dc2626');
        console.error(err);
    }
}

function renderLogs(){
    els.stock.innerHTML = logs.map(l => `
        <tr>
            <td>${new Date(l.time).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</td>
            <td><strong>${l.barcode}</strong><br><small style="color:#64748b">${l.name}</small></td>
            <td><span class="badge ${l.action.toLowerCase()}">${l.action}</span></td>
        </tr>
    `).join('');
}

function clearData(){
    if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ logs=[]; localStorage.removeItem('logs_s4'); renderLogs(); }
}

function showFeedback(text, color){
    els.feedback.innerText = text;
    els.feedback.style.background = color;
    els.feedback.style.opacity = 1;
    setTimeout(() => els.feedback.style.opacity = 0, 2000);
}

// ================= GENERATE & PRINT ENGINE (The Pro Part) =================
async function requestBarcodes(){
    const name = document.getElementById('genName').value.trim();
    const qty = parseInt(document.getElementById('genQty').value);
    
    if(!name || qty <= 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

    showFeedback('‚òÅÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å Server...', '#334155');

    try {
        const res = await fetch(SHEET_URL, {
            method: 'POST',
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏Ñ‡πà name ‡∏Å‡∏±‡∏ö qty (Server ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ running number ‡πÄ‡∏≠‡∏á)
            body: JSON.stringify({ actionType: 'GENERATE', name: name, qty: qty })
        });
        const data = await res.json();
        
        if(data.status === 'success'){
            generateLabels(name, data.start, data.end);
            showFeedback('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '#16a34a');
        }
    } catch (err) {
        alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
    }
}

function generateLabels(name, start, end){
    els.labels.innerHTML = '';
    const mode = els.mode.value;
    const w = els.w.value || 50;
    const h = els.h.value || 30;

    // Dynamic Style Injection for Print
    const styleId = 'dynamic-print-style';
    let oldStyle = document.getElementById(styleId);
    if(oldStyle) oldStyle.remove();

    const style = document.createElement('style');
    style.id = styleId;

    if(mode === 'Single'){
        style.innerHTML = `@media print { 
            @page { size: ${w}mm ${h}mm; margin: 0; } 
            .label { width: ${w}mm; height: ${h}mm; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        }`;
        els.labels.style.display = 'block'; // Block layout for thermal
    } else {
        style.innerHTML = `@media print { 
            @page { size: A4; margin: 0.5cm; } 
            .labels { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
            .label { border: 1px dashed #ccc !important; height: auto; padding: 10px; }
        }`;
        els.labels.style.display = 'grid'; // Grid layout for A4
    }
    document.head.appendChild(style);

    // Loop Generate
    for(let i = start; i <= end; i++){
        // üî• Format: NAME-0001! (4 digits padding)
        const num = String(i).padStart(4, '0');
        const fullCode = `${name}-${num}!`; // ‡∏°‡∏µ ! ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ Scanner ‡∏ï‡∏±‡∏î‡∏à‡∏ö

        const div = document.createElement('div');
        div.className = 'label';
        
        // Preview Size (On Screen)
        if(mode === 'Single'){
            div.style.width = `${w}mm`;
            div.style.height = `${h}mm`;
            div.style.margin = '0 auto 10px auto';
            div.style.border = '1px solid #ddd';
        }

        // HTML Structure
        div.innerHTML = `
            <div class="label-name">${name}</div>
            <svg id="bc_${i}"></svg>
            <div class="label-code">${fullCode}</div>
        `;
        els.labels.appendChild(div);

        // üî• BARCODE RENDERING LOGIC (The Fix) üî•
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Scale ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Width ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© 50mm, width=1.7 ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 10-12 ‡∏ï‡∏±‡∏ß
        
        try {
            JsBarcode(`#bc_${i}`, fullCode, {
                format: "CODE128",
                width: 1.7,       // ‡∏´‡∏ô‡∏≤‡∏û‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏à‡∏ô‡∏•‡πâ‡∏ô
                height: (mode === 'Single' ? (h * 0.5) : 40), // ‡∏™‡∏π‡∏á 50% ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
                displayValue: false, // ‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏á‡∏™‡∏ß‡∏¢‡∏Å‡∏ß‡πà‡∏≤
                margin: 0
            });
        } catch (e) {
            div.innerHTML += '<small style="color:red">‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</small>';
        }
    }
}

// ================= CAMERA =================
let lastCamTime = 0;
function startCamera(){
    document.getElementById('cameraArea').style.display='block';
    Quagga.init({
        inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#cameraStream'), constraints: { facingMode: "environment" } },
        decoder: { readers: ["code_128_reader"] },
        locate: true
    }, (err) => { if(!err) Quagga.start(); });
    
    Quagga.onDetected((data) => {
        const now = Date.now();
        if(now - lastCamTime < 2000) return; // Debounce 2 sec
        lastCamTime = now;
        processScan(data.codeResult.code.replace(/!/g,''));
    });
}
function stopCamera(){ Quagga.stop(); document.getElementById('cameraArea').style.display='none'; }

</script>
</body>
</html>
