<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>S4 Professional Stock</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

<style>
/* CSS ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏π‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏¥‡πâ‡∏ô */
:root { --primary: #2563eb; --bg: #f1f5f9; }
body { font-family: 'Sarabun', sans-serif; background: var(--bg); padding: 20px; color: #333; max-width: 800px; margin: 0 auto; }
.card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
input, select { width: 100%; padding: 12px; font-size: 16px; margin-top: 5px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-top:10px; }
.btn-primary { background: var(--primary); }
.btn-print { background: #334155; }
.btn-cam { background: #16a34a; width: auto; padding: 0 20px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
.badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
.in { background: #dcfce7; color: #16a34a; }
.out { background: #fee2e2; color: #dc2626; }

/* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î */
.labels { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
.label { 
    background: white; border: 1px solid #e2e8f0; border-radius: 8px; 
    padding: 5px; text-align: center; 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.label-name { font-weight: bold; font-size: 16px; margin-bottom: 2px; line-height: 1.2; }
.label-code { font-family: 'Roboto Mono', monospace; font-size: 14px; margin-top: 2px; font-weight: bold; }
/* üî• ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ browser ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡∏ö Pixel Perfect (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ö‡∏•‡∏≠) */
.label svg { shape-rendering: crispEdges; max-width: 100%; height: auto; }

#scanFeedback { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; }
#cameraArea { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; }
#cameraStream { width: 100%; height: 100%; object-fit: cover; }

/* Setting Box */
.settings-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed #cbd5e1; margin-bottom: 15px; }

/* PRINT MODE */
@media print {
    body * { visibility: hidden; }
    #printArea, #printArea * { visibility: visible; }
    #printArea { position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 0; }
    .labels { display: block; }
    .label { border: none !important; page-break-after: always; margin: 0 auto; }
    @page { margin: 0; size: auto; }
}
</style>
</head>
<body>

<h2 style="text-align:center;">üì¶ S4 Professional Stock</h2>

<div class="card">
    <div style="display:flex; gap:10px;">
        <input id="barcode" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î..." autofocus>
        <button class="btn-cam" onclick="startCamera()">üì∑</button>
    </div>
</div>

<div class="card">
    <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <button onclick="clearData()" style="float:right; width:auto; font-size:12px; background:#fee2e2; color:red; padding:5px 10px;">‡∏•‡πâ‡∏≤‡∏á</button></h3>
    <table>
        <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
        <tbody id="stock"></tbody>
    </table>
</div>

<div class="card">
    <h3>üñ®Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (Auto-Run)</h3>
    
    <div class="settings-box">
        <label>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</label>
        <div style="display:flex; gap:10px;">
            <select id="printMode" onchange="toggleSettings()">
                <option value="Single">Thermal (‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏°‡πâ‡∏ß‡∏ô)</option>
                <option value="A4">A4 (‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
            </select>
            <div id="sizeInputs" style="display:flex; gap:5px; flex:1;">
                <input id="pWidth" type="number" value="50"> <span style="align-self:center">x</span>
                <input id="pHeight" type="number" value="30"> <span style="align-self:center">mm</span>
            </div>
        </div>
    </div>

    <input id="genName" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô 18802">
    <input id="genQty" type="number" value="10">

    <div style="display:flex; gap:10px;">
        <button class="btn-primary" onclick="requestBarcodes()">‚òÅÔ∏è ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>
    </div>
</div>

<div id="printArea">
    <div class="labels" id="labels"></div>
</div>

<div id="cameraArea">
    <button onclick="stopCamera()" style="position:absolute; top:20px; right:20px; background:red; width:auto;">‚ùå ‡∏õ‡∏¥‡∏î</button>
    <div id="cameraStream"></div>
</div>
<div id="scanFeedback"></div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxlC36QoUV37QvM6fazvGOlf5daaHrmdVTjQuHqpRnX_kTOFt7q3JbjwZ7H-rHBM00/exec';

let logs = JSON.parse(localStorage.getItem('logs_s4') || '[]');
const els = { barcode: document.getElementById('barcode'), stock: document.getElementById('stock'), labels: document.getElementById('labels'), feedback: document.getElementById('scanFeedback') };

// Load Settings
if(localStorage.getItem('print_w')) document.getElementById('pWidth').value = localStorage.getItem('print_w');
if(localStorage.getItem('print_h')) document.getElementById('pHeight').value = localStorage.getItem('print_h');

function toggleSettings(){
    const isSingle = document.getElementById('printMode').value === 'Single';
    document.getElementById('sizeInputs').style.visibility = isSingle ? 'visible' : 'hidden';
    localStorage.setItem('print_w', document.getElementById('pWidth').value);
    localStorage.setItem('print_h', document.getElementById('pHeight').value);
}
document.getElementById('pWidth').addEventListener('input', toggleSettings);
document.getElementById('pHeight').addEventListener('input', toggleSettings);
toggleSettings();

// SCAN PROCESS
els.barcode.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); processScan(); } });

async function processScan(code=null){
    let raw = code || els.barcode.value.replace(/!/g,'').trim();
    if(!raw) return;

    // üî• LOGIC ‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏Ç‡∏µ‡∏î‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏µ‡∏î (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
    // 18802001 -> ‡∏ï‡∏±‡∏î 3 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ -> 18802
    // 18802-001 -> ‡∏ï‡∏±‡∏î -001 -> 18802
    let productKey = raw.replace(/-/g, '').slice(0, -3); // ‡∏ï‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô 3 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å

    try {
        const res = await fetch(SHEET_URL, {
            method: 'POST', body: JSON.stringify({ actionType: 'GET_PRODUCT', code: productKey, fullBarcode: raw })
        });
        const data = await res.json();

        if(data.status !== 'success'){
            showFeedback('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'red'); els.barcode.value = ''; return;
        }

        let action = (data.last_action === 'IN') ? 'OUT' : 'IN';
        fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'LOG', barcode: raw, name: data.full_name, action: action, fixedCode: data.code }) });

        logs.unshift({ time: Date.now(), barcode: raw, name: data.full_name, action: action });
        if(logs.length > 20) logs.pop();
        localStorage.setItem('logs_s4', JSON.stringify(logs));
        renderLogs();
        els.barcode.value = '';
        showFeedback(`‚úÖ ${action}: ${data.full_name}`, action==='IN'?'green':'red');
    } catch (err) { alert('Server Error'); }
}

function renderLogs(){
    els.stock.innerHTML = logs.map(l => `
        <tr><td>${new Date(l.time).toLocaleTimeString('th-TH')}</td><td>${l.barcode}<br><small>${l.name}</small></td><td><span class="badge ${l.action.toLowerCase()}">${l.action}</span></td></tr>
    `).join('');
}
function clearData(){ if(confirm('‡∏•‡πâ‡∏≤‡∏á?')){ logs=[]; localStorage.removeItem('logs_s4'); renderLogs(); } }
function showFeedback(text, color){ els.feedback.innerText = text; els.feedback.style.background = color; els.feedback.style.opacity = 1; setTimeout(() => els.feedback.style.opacity = 0, 1500); }

// GENERATE PROCESS
async function requestBarcodes(){
    const name = document.getElementById('genName').value.trim();
    const qty = parseInt(document.getElementById('genQty').value);
    if(!name || qty <= 0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

    const res = await fetch(SHEET_URL, { method: 'POST', body: JSON.stringify({ actionType: 'GENERATE', name: name, qty: qty }) });
    const data = await res.json();
    if(data.status === 'success'){ generateLabels(name, data.start, data.end); }
}

function generateLabels(name, start, end){
    els.labels.innerHTML = '';
    const mode = document.getElementById('printMode').value;
    const w = document.getElementById('pWidth').value || 50;
    const h = document.getElementById('pHeight').value || 30;

    // Inject CSS for Print
    const style = document.createElement('style');
    style.innerHTML = (mode === 'Single') 
        ? `@media print { @page { size: ${w}mm ${h}mm; margin: 0; } .label { width: ${w}mm; height: ${h}mm; display: flex; flex-direction: column; justify-content: center; align-items: center; } }`
        : `@media print { @page { size: A4; margin: 0.5cm; } .labels { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; } .label { border: 1px dashed #ccc !important; height: auto; padding: 10px; } }`;
    document.head.appendChild(style);

    for(let i = start; i <= end; i++){
        // üî• FORMULA: ‡∏•‡∏î‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 3 ‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏≤‡∏Ç‡∏µ‡∏î‡∏≠‡∏≠‡∏Å
        // Human Readable: 18802-001 (‡∏°‡∏µ‡∏Ç‡∏µ‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢)
        // Machine Code:   18802001! (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏µ‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà)
        
        const num = String(i).padStart(3, '0'); // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 3 ‡∏´‡∏•‡∏±‡∏Å (001)
        const humanText = `${name}-${num}`;     // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡πÄ‡∏´‡πá‡∏ô
        const machineCode = `${name}${num}!`;   // ‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô (‡πÄ‡∏≠‡∏≤‡∏Ç‡∏µ‡∏î‡∏≠‡∏≠‡∏Å)

        const div = document.createElement('div');
        div.className = 'label';
        if(mode === 'Single'){ div.style.width = `${w}mm`; div.style.height = `${h}mm`; }

        div.innerHTML = `
            <div class="label-name">${name}</div>
            <svg id="bc_${i}"></svg>
            <div class="label-code">${humanText}</div>
        `;
        els.labels.appendChild(div);

        // üî• FIX: ‡πÉ‡∏ä‡πâ Width: 2 (‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
        try {
            JsBarcode(`#bc_${i}`, machineCode, {
                format: "CODE128",
                width: 2,           // ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î!
                height: (mode === 'Single' ? (h * 0.5) : 35),
                displayValue: false, 
                margin: 0
            });
        } catch (e) {
            div.innerHTML += '<small style="color:red;font-size:10px">‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô</small>';
        }
    }
}

// CAMERA
let lastCam=0;
function startCamera(){
    document.getElementById('cameraArea').style.display='block';
    Quagga.init({ inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#cameraStream'), constraints: { facingMode: "environment" } }, decoder: { readers: ["code_128_reader"] }, locate: true }, (err) => { if(!err) Quagga.start(); });
    Quagga.onDetected((d) => { if(Date.now()-lastCam<2000)return; lastCam=Date.now(); processScan(d.codeResult.code.replace(/!/g,'')); });
}
function stopCamera(){ Quagga.stop(); document.getElementById('cameraArea').style.display='none'; }

renderLogs();
</script>
</body>
</html>
